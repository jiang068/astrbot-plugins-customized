# AstrBot JM2PDF 插件

这是一个 AstrBot 插件，用于下载禁漫天堂（JMComic）的漫画并自动转换为 PDF 文件发送给用户。

> **⚠️ 内存优化提示：** 
> 默认配置已针对多用户场景优化（约50-150MB/用户）。如果仍遇到内存问题，请参考[内存优化配置](#内存占用过高)章节。

## 功能特点

- 🚀 简单易用：只需发送 `jm <漫画ID>` 即可下载并转换
- 📥 自动下载：使用 JMComic-Crawler-Python 自动处理域名和网络连接
- 📄 无损转换：使用 img2pdf 进行无损 PDF 转换
- 🎨 格式处理：自动处理 RGBA、透明背景等特殊格式图片
- 📑 智能排序：按文件名自然排序确保页面顺序正确
- 🧹 自动清理：下载和发送后自动清理临时文件
- ⚡ 异步处理：下载和转换在后台线程执行，不会阻塞其他插件运行
- 📊 任务队列：支持并发控制，多用户同时请求时自动排队并提示队列位置
- ⏱️ 超时保护：下载超时后自动转换已下载的部分图片，避免长时间等待
- 🧠 内存优化：智能并发控制，支持低内存服务器运行

## 安装

### 1. 安装依赖

```bash
pip install jmcomic img2pdf
```

### 2. 安装插件

将此插件目录放置到 AstrBot 的插件目录中。

## 使用方法

### 基本命令

```
/jm <漫画ID>
```

### 示例

```
/jm 123456
```

### 任务队列示例

当 `max_concurrent_tasks=2` 时的多用户场景：

**场景：3个用户同时请求**
1. **用户A** 发送 `/jm 111111`
   - 机器人回复：`📥 开始下载漫画 111111，请稍候...`
   - 任务开始执行

2. **用户B** 发送 `/jm 222222`（同时）
   - 机器人回复：`📥 开始下载漫画 222222，请稍候...`
   - 任务开始执行

3. **用户C** 发送 `/jm 333333`（此时队列已满）
   - 机器人回复：`⏳ 当前下载任务较多，您的请求正在排队... 📊 前方还有 1 个任务`
   - 等待用户A或B的任务完成

4. 当用户A的任务完成后
   - 机器人向用户C发送：`✅ 轮到您了！开始下载漫画 333333...`
   - 用户C的任务开始执行

> **提示**：
> - 队列功能确保服务器不会因为同时下载过多漫画而崩溃
> - 已下载的PDF会被缓存（如果启用 `keep_pdf`），再次请求时无需排队
> - 建议根据服务器性能设置 `max_concurrent_tasks`（1-3）

### 超时保护示例

**场景：下载大型漫画时网络不稳定**

1. **用户** 发送 `/jm 999999`（假设这是一个很大的漫画）
   - 机器人回复：`📥 开始下载漫画 999999，请稍候...`

2. **下载进行中**（假设设置 `task_timeout_minutes=10`）
   - 5分钟过去了，下载了50%的图片
   - 10分钟到达，下载还未完成

3. **触发超时**
   - 机器人停止下载
   - 机器人回复：`⚠️ 下载任务超时（10分钟），尝试转换已下载的图片...`

4. **转换并发送部分内容**
   - 机器人将已下载的50%图片转换为PDF
   - 机器人回复：`✅ 已将部分下载的图片转换为PDF (15.3 MB)，准备发送...`
   - 发送PDF文件
   - 机器人提示：`⚠️ 注意：此PDF仅包含超时前下载的部分图片`

> **提示**：
> - 超时机制避免了因网络问题导致的无限等待
> - 即使超时，用户也能获得部分内容，而不是一无所获
> - 可根据实际网络环境调整 `task_timeout_minutes`（建议10-30分钟）

### 两种模式

**1. 静默模式（`send_progress_message: false`）**
- 用户发送指令后，机器人不会发送任何进度消息
- 只在最后发送 PDF 文件或错误消息
- 适合不想被进度消息打扰的用户

**2. 进度提示模式（`send_progress_message: true`，默认）**
- 机器人会发送下载进度、转换进度等消息
- 让用户了解当前处理状态
- 适合需要实时反馈的场景

### 处理流程

机器人会：
1. ✅ 验证漫画ID格式
2. � 检查是否已存在PDF文件（如果存在则直接发送，跳过下载）
3. �📥 下载指定漫画的所有章节
4. 🔄 将图片按顺序转换为PDF
5. 📤 发送PDF文件给用户
6. 🧹 自动清理临时文件（可配置保留）

> **提示**：设置 `keep_pdf=true` 可以缓存已下载的PDF，重复请求同一漫画时会直接发送已有文件，大幅提升响应速度！

## 配置

插件使用 `_conf_schema.json` 文件定义配置项。在 AstrBot 管理界面可以直接配置以下选项：

### 🚀 快速配置指南

根据您的服务器内存选择合适的配置：

| 场景 | 服务器内存 | 并发用户 | concurrent_images | concurrent_photos | max_concurrent_tasks | 预估内存/任务 |
|------|-----------|---------|-------------------|-------------------|---------------------|--------------|
| **低内存** | <2GB | 少量 | 5 | 1 | 1 | ~20MB |
| **推荐配置** | 2-4GB | 中等 | 8 | 2 | 2 | ~50MB |
| **高性能** | >4GB | 较多 | 20 | 4 | 3 | ~200MB |

> **💡 计算公式：** 内存占用 ≈ concurrent_images × concurrent_photos × 单图大小(3-5MB)

### 基础配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `download_dir` | string | `./jm_downloads` | 漫画下载和PDF生成的临时目录 |
| `whitelist_groups` | string | `""` | 白名单群组ID列表（逗号分隔）。**留空表示所有群组都可用** |
| `whitelist_users` | string | `""` | 白名单用户ID列表（逗号分隔）。**留空表示所有用户都可用** |
| `keep_images` | boolean | `false` | 下载完成后是否保留原始图片文件 |
| `keep_pdf` | boolean | `false` | 发送完成后是否保留生成的PDF文件。**建议设为true启用缓存，重复请求时直接发送已有PDF** |
| `max_file_size_mb` | integer | `0` | PDF文件大小限制(MB)，0表示不限制 |

### 白名单说明

插件支持双重白名单机制，**用户白名单和群组白名单独立判断**：

**白名单逻辑（AND）：**
- **用户白名单**：
  - 为空 = 允许所有用户
  - 有值 = 只允许白名单中的用户
  
- **群组白名单**：
  - 为空 = 允许所有群组
  - 有值 = 只允许白名单中的群组
  
- **两者同时满足才能使用**

**使用场景：**

1. **所有人都可用**（默认）
   ```json
   {
     "whitelist_groups": "",  // 空
     "whitelist_users": ""     // 空
   }
   ```

2. **只允许特定群组，所有用户都可用**
   ```json
   {
     "whitelist_groups": "123456789,987654321",  // 只允许这两个群
     "whitelist_users": ""                        // 群内所有人都可用
   }
   ```

3. **只允许特定用户，所有群组/私聊都可用**
   ```json
   {
     "whitelist_groups": "",                     // 所有群组开放
     "whitelist_users": "111111111,222222222"   // 但只有这两个用户可用
   }
   ```

4. **组合限制：特定群组+特定用户**
   ```json
   {
     "whitelist_groups": "123456789",    // 只允许这个群
     "whitelist_users": "111111111"      // 且只有这个用户可用
   }
   ```

5. **对所有群组开放，但私聊只对几个人开放**
   ```json
   {
     "whitelist_groups": "",                     // 空 = 所有群组都可用
     "whitelist_users": "111111111,222222222"   // 私聊只有这两个人可用
   }
   ```

**配置示例：**
```json
{
  "whitelist_groups": "123456789,987654321",  // 允许这两个群使用
  "whitelist_users": "111111111,222222222"    // 允许这两个用户使用
}
```

**如何获取ID：**
- **群组ID**：可以通过机器人在群内发送消息时查看日志获取
- **用户ID**：让用户发送消息给机器人，在日志中可以看到 sender_id

### JMComic 客户端配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `jm_client_impl` | string | `html` | 客户端类型：html(网页端)或api(APP端)。**如遇IP限制请切换为api** |
| `jm_retry_times` | integer | `5` | 请求失败重试次数 |
| `jm_cookies_avs` | string | `""` | 登录Cookie(AVS)，用于访问需要登录的内容 |

> **提示**：插件会自动获取最新可用域名，无需手动配置。如遇访问问题，建议：
> 1. 切换客户端类型为 `api`（更稳定，不受IP限制）
> 2. 配置代理（见下方网络配置）
> 3. 如需访问登录内容，配置 `jm_cookies_avs`

### 网络配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `proxy` | string | `""` | HTTP代理地址，支持格式：http://127.0.0.1:7890 或 system/clash/v2ray |
| `timeout` | integer | `60` | 单个请求的超时时间(秒) |

### 下载配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `download_cache` | boolean | `true` | 启用下载缓存，已存在的文件跳过下载 |
| `image_decode` | boolean | `true` | 是否还原JM混淆过的图片（建议开启） |
| `image_suffix` | string | `""` | 图片格式转换，可选：.jpg/.png/.webp |
| `concurrent_images` | integer | `8` | 并发下载图片数(1-50)，**影响内存占用** |
| `concurrent_photos` | integer | `2` | 并发下载章节数(1-16)，**影响内存占用** |

> **⚠️ 内存优化重要提示：**
> - `concurrent_images` × `concurrent_photos` = 同时在内存中的图片数量
> - 默认配置：8 × 2 = 16张图片同时在内存（约50-150MB/用户）
> - 如果3个用户并发：16 × 3 = 48张图片（约150-450MB）
> - **高并发场景建议：**
>   - `concurrent_images`: 5-8（降低单用户内存占用）
>   - `concurrent_photos`: 1-2（避免多章节同时加载）
>   - `max_concurrent_tasks`: 1-2（限制并发用户数）
> - **内存充足场景：**
>   - `concurrent_images`: 20-30（提升下载速度）
>   - `concurrent_photos`: 4-8（加快整体进度）

### 文件夹配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `dir_rule` | string | `Bd/Ptitle` | 目录规则，如：Bd/Aid/Pindex |
| `normalize_zh` | string | `""` | 中文繁简转换：zh-cn(简体)/zh-tw(繁体) |

### 其他配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enable_jm_log` | boolean | `false` | 是否显示JMComic库的详细日志 |
| `send_progress_message` | boolean | `true` | 是否发送进度消息（关闭后只发送PDF或错误） |
| `log_level` | string | `simple` | 日志详细级别：simple(简略)/detailed(详细) |
| `max_concurrent_tasks` | integer | `2` | 最大并发任务数(1-5)，控制同时下载的漫画数量 |
| `task_timeout_minutes` | integer | `10` | 任务超时时间(分钟)，超时后转换已下载图片 |

**日志级别说明：**
- `simple`（简略）：只记录关键操作日志（初始化、开始下载、下载完成、PDF转换成功、PDF发送）
- `detailed`（详细）：记录所有操作日志（包括配置读取、临时目录、文件收集、清理等详细信息）

**任务队列说明：**
- `max_concurrent_tasks` 控制同时处理的下载任务数量，防止资源耗尽
- 设置为 `2` 表示最多同时处理 2 个下载任务
- 当第 3 个用户请求时，会进入排队状态，并收到提示："⏳ 当前下载任务较多，您的请求正在排队... 📊 前方还有 1 个任务"
- 前面任务完成后，会通知等待的用户："✅ 轮到您了！开始下载漫画..."
- 建议值：1-3（根据服务器性能调整）
- 设置为 `0` 表示不限制并发数（不推荐）

**任务超时说明：**
- `task_timeout_minutes` 控制单个下载任务的最大执行时间（分钟）
- 当任务超过设定时间仍未完成时，会自动停止下载
- 超时后，插件会尝试将**已下载的图片**转换为PDF并发送给用户
- 用户会收到提示："⚠️ 下载任务超时，尝试转换已下载的图片..."
- 建议值：10-30分钟（根据网络环境和漫画大小调整）
- 设置为 `0` 表示不限制超时时间

### 配置示例

**推荐配置（内存优化，适合多用户场景）：**
```json
{
  "download_dir": "/home/user/jm_downloads",
  "whitelist_groups": "",
  "whitelist_users": "",
  "keep_images": false,
  "keep_pdf": true,
  "max_file_size_mb": 100,
  "jm_client_impl": "api",
  "jm_retry_times": 5,
  "jm_cookies_avs": "",
  "proxy": "",
  "timeout": 60,
  "download_cache": true,
  "image_decode": true,
  "image_suffix": "",
  "concurrent_images": 8,
  "concurrent_photos": 2,
  "dir_rule": "Bd/Ptitle",
  "normalize_zh": "",
  "enable_jm_log": false,
  "send_progress_message": true,
  "log_level": "simple",
  "max_concurrent_tasks": 2,
  "task_timeout_minutes": 10
}
```

**高性能配置（内存充足，追求速度）：**
```json
{
  "keep_pdf": true,
  "concurrent_images": 30,
  "concurrent_photos": 8,
  "max_concurrent_tasks": 3,
  "task_timeout_minutes": 15
}
```

**低内存配置（服务器内存较小）：**
```json
{
  "keep_pdf": true,
  "concurrent_images": 5,
  "concurrent_photos": 1,
  "max_concurrent_tasks": 1,
  "task_timeout_minutes": 20
}
```

### 目录规则说明

`dir_rule` 配置项用于控制下载文件的目录结构，支持以下变量：

**Album (本子) 相关：**
- `Aid` - 本子ID
- `Atitle` - 本子标题
- `Aauthor` - 本子作者
- `Aname` - 本子名称

**Photo (章节) 相关：**
- `Pid` - 章节ID
- `Pindex` - 章节序号
- `Ptitle` - 章节标题
- `Pname` - 章节名称

**示例：**
- `Bd/Aid/Pindex` → 根目录/本子ID/章节序号/
- `Bd/Ptitle` → 根目录/章节标题/ (默认)
- `Bd/Aauthor/(JM{Aid}-{Pindex})-{Pname}` → 根目录/作者/(JM本子ID-章节号)-章节名/

## 依赖项

- `jmcomic` - 禁漫天堂爬虫库
- `img2pdf` - 图片转PDF库（自动处理所有图片格式）

## 注意事项

- ⚠️ 请遵守相关法律法规，合理使用本插件
- ⚠️ 请不要一次性下载过多漫画，减轻服务器压力
- ⚠️ 确保有足够的磁盘空间存储临时文件
- ⚠️ 大文件可能需要较长的上传时间
- ✅ 下载和转换过程在后台线程运行，不会阻塞其他插件

## 技术说明

### 异步处理

插件使用 `asyncio.to_thread()` 在后台线程池中运行阻塞操作：
- **下载过程**：`jmcomic.download_album()` 在独立线程运行，不阻塞事件循环
- **PDF转换**：`img2pdf.convert()` 在独立线程运行，即使处理几千张图片也不会卡住
- **其他插件**：完全不受影响，AstrBot 可以同时处理其他消息和命令

这意味着即使正在下载一个包含几千张图的大本子，用户仍然可以：
- 使用其他插件的命令
- 发送其他消息
- 触发其他事件

### 下载流程

1. 用户发送 `jm <ID>` 命令
2. 验证漫画ID格式（必须是纯数字）
3. 创建临时目录
4. 使用 `jmcomic.download_album(comic_id)` 下载漫画
5. 自动处理域名和网络连接问题

### PDF转换流程

1. 递归收集下载目录中的所有图片文件
2. 按文件名自然排序确保页面顺序正确
3. 直接使用 img2pdf 进行无损转换
   - JPEG/JPEG2000 → 直接嵌入（无重新编码）
   - PNG（无透明度）→ 直接嵌入
   - 其他格式 → img2pdf 自动应用最优压缩算法
4. 生成 PDF 文件并发送给用户
5. 清理临时文件和 PDF 文件

### 图片处理

- img2pdf 自动处理所有图片格式，无需手动转换
- 支持的图片格式：jpg, jpeg, png, gif, bmp, webp, tif, tiff
- 对于 JPEG/PNG 等常见格式，直接嵌入 PDF（零损耗、高速度、低内存）
- 对于特殊格式（RGBA、透明背景等），img2pdf 自动应用最优算法处理

## 故障排除

### 缺少依赖库

```
❌ 缺少必要的依赖库，请先安装 jmcomic 和 img2pdf
```

解决方法：
```bash
pip install jmcomic img2pdf
```

### 无效的漫画ID

```
❌ 无效的漫画ID格式: xxx
```

解决方法：确保输入的是纯数字ID，例如 `/jm 123456`

### 下载失败

可能的原因：
- 网络连接问题
- 漫画ID不存在
- 服务器限制

请检查日志获取详细错误信息。

### 内存占用过高

**症状：**
- 多个用户下载时服务器内存暴涨
- 系统变慢或出现OOM（内存不足）错误
- 例如：3个用户并发下载就占用1GB+内存

**原因分析：**
```
内存占用 = concurrent_images × concurrent_photos × 用户数 × 单张图片大小
示例：30 × 8 × 3 × 4MB = 2.8GB
```

**解决方案（按优先级）：**

1. **降低并发图片数**（最有效）
   ```json
   {
     "concurrent_images": 8,    // 从30降到8
     "concurrent_photos": 2     // 从8降到2
   }
   ```
   效果：8 × 2 × 3 × 4MB ≈ 192MB（减少93%）

2. **限制并发用户数**
   ```json
   {
     "max_concurrent_tasks": 1  // 一次只允许1个用户下载
   }
   ```
   效果：其他用户自动排队，避免同时占用内存

3. **启用PDF缓存**
   ```json
   {
     "keep_pdf": true  // 重复请求直接发送缓存，无需重新下载
   }
   ```

4. **使用低内存配置预设**（见上方"低内存配置"）

**推荐组合配置（内存<2GB服务器）：**
```json
{
  "concurrent_images": 5,
  "concurrent_photos": 1,
  "max_concurrent_tasks": 1,
  "keep_pdf": true
}
```
预期内存：5 × 1 × 1 × 4MB ≈ 20MB/任务

### 下载超时

如果遇到下载超时：
1. 检查 `task_timeout_minutes` 配置是否过短
2. 考虑增加超时时间（建议10-30分钟）
3. 检查网络连接和代理设置
4. 超时后会自动转换已下载的部分图片为PDF

## 更新日志

### v1.5.1 (2025-12-03)
- 🧠 优化默认内存配置，降低并发参数
- 📊 concurrent_images: 30→8, concurrent_photos: 8→2
- 📝 新增详细的内存优化指南和故障排除
- 💡 提供低内存、推荐、高性能三种配置预设
- 🎯 修复多用户并发时内存占用过高问题

### v1.5.0 (2025-12-03)
- ⏱️ 新增任务超时机制（task_timeout_minutes配置）
- 🛡️ 超时后自动转换已下载的图片为PDF
- 📢 超时时向用户发送清晰的状态提示
- 🎯 防止因网络问题导致无限等待

### v1.4.0 (2025-12-03)
- ⚡ 新增异步任务队列功能
- 📊 支持并发任务数量控制（max_concurrent_tasks配置）
- 🔔 排队时自动提示用户前方排队数量
- 🎯 防止大量并发下载导致资源耗尽

### v1.3.0 (2025-12-03)
- ⚡ 新增异步处理功能，下载和转换不再阻塞主事件循环
- 📦 支持PDF缓存功能（keep_pdf配置）
- 🎯 新增白名单功能（群组和用户独立控制）

### v1.2.0 (2025-12-03)
- 🔧 移除手动域名配置，改为自动获取
- 🛠️ 优化客户端类型配置（html/api）
- 📝 优化错误处理和日志输出

### v1.1.0 (2025-12-03)
- ✨ 新增进度消息开关（send_progress_message配置）
- 📊 新增日志级别控制（simple/detailed）
- 🔧 优化配置项和提示信息

### v1.0.0 (2025-12-03)
- 🎉 首次发布
- ✅ 基本的下载和转换功能
- ✅ 自动清理临时文件
- ✅ 特殊格式图片处理

## 许可证

本项目仅供学习交流使用，请勿用于非法用途。

## 贡献

欢迎提交 Issue 和 Pull Request！

## 致谢

- [JMComic-Crawler-Python](https://github.com/hect0x7/JMComic-Crawler-Python) - 禁漫天堂爬虫
- [img2pdf](https://gitlab.mister-muffin.de/josch/img2pdf) - 图片转PDF工具
- [AstrBot](https://github.com/Soulter/AstrBot) - 机器人框架
